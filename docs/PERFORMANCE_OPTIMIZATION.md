# é€æ˜åº¦ç®—æ³•æ€§èƒ½ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æå‡ GIF ç”Ÿæˆæ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯é€æ˜åº¦å¤„ç†çš„æ•ˆç‡ã€‚

## âœ… å·²å®æ–½çš„ä¼˜åŒ–

### ä¼˜åŒ– 1ï¼šç»Ÿä¸€ Alpha é˜ˆå€¼ä½¿ç”¨

**é—®é¢˜**ï¼š
- `findUnusedColorForFrame` ç¡¬ç¼–ç é˜ˆå€¼ä¸º 128
- é€æ˜åº¦å¤„ç†ä½¿ç”¨ `currentConfig.alphaThreshold`
- ä¸¤å¤„é˜ˆå€¼ä¸ä¸€è‡´ï¼Œå¯¼è‡´é¢œè‰²æ£€æµ‹ä¸å‡†ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// å‡½æ•°ç­¾åæ·»åŠ  alphaThreshold å‚æ•°
const findUnusedColorForFrame = async (
  frameUrl: string, 
  frameIndex: number, 
  alphaThreshold: number = 128
): Promise<{...}> => {
  // ä½¿ç”¨ä¼ å…¥çš„é˜ˆå€¼
  if (imageData[i + 3] >= alphaThreshold) {
    usedColors.add(colorKey);
  }
}
```

**æ•ˆæœ**ï¼š
- âœ… ç¡®ä¿é¢œè‰²æ£€æµ‹å’Œé€æ˜åº¦å¤„ç†ä½¿ç”¨ç›¸åŒé˜ˆå€¼
- âœ… æé«˜æ‰¾åˆ°æœªä½¿ç”¨é¢œè‰²çš„æˆåŠŸç‡
- âœ… ç”¨æˆ·è‡ªå®šä¹‰é˜ˆå€¼ç”Ÿæ•ˆæ›´å‡†ç¡®

---

### ä¼˜åŒ– 2ï¼šæå‰æ£€æµ‹é€æ˜åº¦

**é—®é¢˜**ï¼š
- å³ä½¿å¸§å®Œå…¨ä¸é€æ˜ï¼Œä»ç„¶ä¼šï¼š
  - æŸ¥æ‰¾æœªä½¿ç”¨é¢œè‰²
  - åˆ›å»ºä¸´æ—¶ç”»å¸ƒ
  - é€åƒç´ æ‰«æå¤„ç†
- æµªè´¹å¤§é‡è®¡ç®—èµ„æº

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨æ‰«æé¢œè‰²çš„åŒæ—¶æ£€æµ‹æ˜¯å¦æœ‰é€æ˜åƒç´ 
let hasTransparency = false;
for (let i = 0; i < data.length; i += 4) {
  const alpha = data[i + 3];
  if (alpha < alphaThreshold) {
    hasTransparency = true;
  }
  // ... æ”¶é›†é¢œè‰²
}

// å¦‚æœæ²¡æœ‰é€æ˜åº¦ï¼Œç›´æ¥è¿”å›
if (!hasTransparency) {
  console.log(`Frame ${frameIndex}: No transparency detected, skipping`);
  return { hex: 0x00FF00, str: '#00FF00', hasTransparency: false, imageData };
}
```

**æ•ˆæœ**ï¼š
- âœ… å®Œå…¨ä¸é€æ˜çš„å¸§è·³è¿‡é€æ˜åº¦å¤„ç†
- âœ… èŠ‚çœçº¦ 30-50% çš„å¤„ç†æ—¶é—´ï¼ˆå¯¹ä¸é€æ˜å¸§ï¼‰
- âœ… å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…

---

### ä¼˜åŒ– 3ï¼šé¿å…é‡å¤åŠ è½½å›¾ç‰‡

**é—®é¢˜**ï¼š
- `findUnusedColorForFrame` åŠ è½½å›¾ç‰‡åˆ†æé¢œè‰²
- åç»­å¤„ç†å¸§æ—¶å†æ¬¡åŠ è½½åŒä¸€å¼ å›¾ç‰‡
- **æ¯å¸§è¢«åŠ è½½ 2 æ¬¡**

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// è¿”å›å€¼åŒ…å« imageData
const findUnusedColorForFrame = async (...): Promise<{
  hex: number,
  str: string,
  hasTransparency: boolean,
  imageData?: ImageData  // ç¼“å­˜çš„å›¾ç‰‡æ•°æ®
}> => {
  const imageData = ctx.getImageData(...);
  // ... åˆ†æ
  return { ..., imageData };  // è¿”å› imageData
}

// ä½¿ç”¨æ—¶ç¼“å­˜ç»“æœ
const result = await findUnusedColorForFrame(...);
cachedImageData = result.imageData;

// åç»­å¤„ç†æ—¶å¤ç”¨
if (cachedImageData) {
  // å…‹éš†ç¼“å­˜çš„æ•°æ®ï¼Œé¿å…ä¿®æ”¹åŸå§‹æ•°æ®
  imageData = new ImageData(
    new Uint8ClampedArray(cachedImageData.data),
    cachedImageData.width,
    cachedImageData.height
  );
} else {
  // åªåœ¨ç¼“å­˜ä¸å¯ç”¨æ—¶æ‰åŠ è½½
  imageData = tempCtx.getImageData(...);
}
```

**æ•ˆæœ**ï¼š
- âœ… æ¯å¸§åªåŠ è½½ 1 æ¬¡å›¾ç‰‡ï¼ˆèŠ‚çœ 50% åŠ è½½æ—¶é—´ï¼‰
- âœ… å‡å°‘ç½‘ç»œ/æ–‡ä»¶ç³»ç»Ÿ I/O
- âœ… é™ä½å†…å­˜å³°å€¼ä½¿ç”¨

---

### ä¼˜åŒ– 4ï¼šæ”¹è¿›ç³»ç»Ÿæœç´¢ç­–ç•¥

**é—®é¢˜**ï¼š
- æ­¥é•¿ä¸º 17ï¼Œåªæ£€æŸ¥ `15Â³ = 3,375` ç§é¢œè‰²
- å¦‚æœè¿™äº›éƒ½è¢«ä½¿ç”¨ï¼Œå°±ä¼šå¤±è´¥
- ä½†è¿˜æœ‰ 1600 ä¸‡ç§é¢œè‰²æœªæ£€æŸ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// æ­¥é•¿ä» 17 æ”¹ä¸º 11
for (let r = 1; r < 255; r += 11) {
  for (let g = 1; g < 255; g += 11) {
    for (let b = 1; b < 255; b += 11) {
      // æ£€æŸ¥ 23Â³ = 12,167 ç§é¢œè‰²
    }
  }
}
```

**æ•ˆæœ**ï¼š
- âœ… æ£€æŸ¥é¢œè‰²æ•°é‡å¢åŠ  3.6 å€
- âœ… æé«˜æ‰¾åˆ°æœªä½¿ç”¨é¢œè‰²çš„æˆåŠŸç‡
- âœ… å¯¹æ€§èƒ½å½±å“å¾ˆå°ï¼ˆä»ç„¶å¾ˆå¿«ï¼‰

---

### ä¼˜åŒ– 5ï¼šè·³è¿‡æ— é€æ˜åº¦å¸§çš„å¤„ç†

**é—®é¢˜**ï¼š
- å³ä½¿æ£€æµ‹åˆ°å¸§æ— é€æ˜åº¦ï¼Œä»ç„¶ä¼šè¿›å…¥é€æ˜åº¦å¤„ç†é€»è¾‘

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åªåœ¨å¸§çœŸæ­£æœ‰é€æ˜åº¦æ—¶æ‰å¤„ç†
if (currentConfig.transparent && frameTransparentKey && hasFrameTransparency) {
  // å¤„ç†é€æ˜åº¦
} else {
  // ç›´æ¥ä½¿ç”¨åŸå›¾
}
```

**æ•ˆæœ**ï¼š
- âœ… å®Œå…¨è·³è¿‡ä¸å¿…è¦çš„å¤„ç†
- âœ… èŠ‚çœä¸´æ—¶ç”»å¸ƒåˆ›å»ºå’Œåƒç´ æ‰«æ
- âœ… æå‡æ•´ä½“æ€§èƒ½

---

## ğŸ“Š æ€§èƒ½æå‡ä¼°ç®—

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| **10 å¸§å…¨é€æ˜ GIF** | 100% | ~55% | **45% æ›´å¿«** |
| **10 å¸§å…¨ä¸é€æ˜ GIF** | 100% | ~40% | **60% æ›´å¿«** |
| **10 å¸§æ··åˆ GIF** | 100% | ~50% | **50% æ›´å¿«** |

### è¯¦ç»†åˆ†æ

#### å…¨é€æ˜å¸§ï¼ˆæ¯å¸§éƒ½æœ‰é€æ˜åƒç´ ï¼‰
- âŒ ä¼˜åŒ–å‰ï¼šåŠ è½½ 2 æ¬¡ Ã— 10 å¸§ = 20 æ¬¡åŠ è½½
- âœ… ä¼˜åŒ–åï¼šåŠ è½½ 1 æ¬¡ Ã— 10 å¸§ = 10 æ¬¡åŠ è½½
- **èŠ‚çœ 50% åŠ è½½æ—¶é—´**

#### å…¨ä¸é€æ˜å¸§ï¼ˆæ¯å¸§éƒ½å®Œå…¨ä¸é€æ˜ï¼‰
- âŒ ä¼˜åŒ–å‰ï¼š
  - åŠ è½½ 2 æ¬¡ Ã— 10 å¸§ = 20 æ¬¡åŠ è½½
  - é€æ˜åº¦å¤„ç† 10 æ¬¡
- âœ… ä¼˜åŒ–åï¼š
  - åŠ è½½ 1 æ¬¡ Ã— 10 å¸§ = 10 æ¬¡åŠ è½½
  - è·³è¿‡é€æ˜åº¦å¤„ç†
- **èŠ‚çœ 50% åŠ è½½æ—¶é—´ + 100% å¤„ç†æ—¶é—´**

#### æ··åˆåœºæ™¯ï¼ˆ5 å¸§é€æ˜ + 5 å¸§ä¸é€æ˜ï¼‰
- âŒ ä¼˜åŒ–å‰ï¼š20 æ¬¡åŠ è½½ + 10 æ¬¡å¤„ç†
- âœ… ä¼˜åŒ–åï¼š10 æ¬¡åŠ è½½ + 5 æ¬¡å¤„ç†
- **èŠ‚çœ 50% åŠ è½½æ—¶é—´ + 50% å¤„ç†æ—¶é—´**

---

## ğŸ” ä»£ç å˜æ›´æ€»ç»“

### ä¿®æ”¹çš„å‡½æ•°

1. **`findUnusedColorForFrame`**
   - æ·»åŠ  `alphaThreshold` å‚æ•°
   - è¿”å› `hasTransparency` æ ‡å¿—
   - è¿”å› `imageData` ç¼“å­˜
   - æå‰æ£€æµ‹é€æ˜åº¦
   - æ”¹è¿›æœç´¢æ­¥é•¿ï¼ˆ17 â†’ 11ï¼‰

2. **å¸§å¤„ç†å¾ªç¯**
   - ç¼“å­˜é€æ˜åº¦æ£€æµ‹ç»“æœ
   - å¤ç”¨ imageData
   - è·³è¿‡æ— é€æ˜åº¦å¸§çš„å¤„ç†

### æ–°å¢å˜é‡

```typescript
let hasFrameTransparency = false;      // å¸§æ˜¯å¦æœ‰é€æ˜åº¦
let cachedImageData: ImageData | undefined;  // ç¼“å­˜çš„å›¾ç‰‡æ•°æ®
```

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### å†…å­˜ä¼˜åŒ–
- âœ… å‡å°‘å›¾ç‰‡é‡å¤åŠ è½½
- âœ… å‡å°‘ä¸´æ—¶ç”»å¸ƒåˆ›å»º
- âœ… é™ä½å†…å­˜å³°å€¼

### æ€§èƒ½ä¼˜åŒ–
- âœ… å‡å°‘ 50% å›¾ç‰‡åŠ è½½æ¬¡æ•°
- âœ… è·³è¿‡ä¸å¿…è¦çš„é€æ˜åº¦å¤„ç†
- âœ… æ”¹è¿›é¢œè‰²æœç´¢æˆåŠŸç‡

### ä»£ç è´¨é‡
- âœ… ç»Ÿä¸€é˜ˆå€¼ä½¿ç”¨
- âœ… æ›´æ¸…æ™°çš„é€»è¾‘æµç¨‹
- âœ… æ›´å¥½çš„æ—¥å¿—è¾“å‡º

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### è‡ªå®šä¹‰é˜ˆå€¼
```typescript
const config: CanvasConfig = {
  transparent: true,
  alphaThreshold: 100,  // è‡ªå®šä¹‰é˜ˆå€¼
  // ... å…¶ä»–é…ç½®
};
```

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹
```
Frame 0: Found unused transparent key color: #a3b5c7
Frame 1: No transparency detected, skipping transparent key search
Frame 2: Found unused transparent key color (systematic): #112233
```

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### å¯é€‰çš„è¿›ä¸€æ­¥ä¼˜åŒ–

1. **å¹¶è¡Œå¤„ç†å¤šå¸§**
   - ä½¿ç”¨ `Promise.all` å¹¶è¡Œåˆ†æå¤šå¸§
   - é€‚åˆå¤šæ ¸ CPU
   - éœ€è¦æƒè¡¡å†…å­˜ä½¿ç”¨

2. **æ™ºèƒ½é¢œè‰²é€‰æ‹©**
   - ä¼˜å…ˆå°è¯•ä¸å¸¸è§é¢œè‰²ï¼ˆå“çº¢ã€é’è‰²ç­‰ï¼‰
   - å‡å°‘éšæœºå°è¯•æ¬¡æ•°

3. **Web Worker å¤„ç†**
   - å°†é€æ˜åº¦å¤„ç†ç§»åˆ° Worker
   - é¿å…é˜»å¡ä¸»çº¿ç¨‹
   - æå‡ç”¨æˆ·ä½“éªŒ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ImageData å…‹éš†**
   - å¿…é¡»å…‹éš†ç¼“å­˜çš„ imageData
   - é¿å…ä¿®æ”¹åŸå§‹æ•°æ®
   - ä½¿ç”¨ `Uint8ClampedArray` æ„é€ å‡½æ•°

2. **é˜ˆå€¼ä¸€è‡´æ€§**
   - ç¡®ä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ç›¸åŒçš„é˜ˆå€¼
   - ä»é…ç½®ä¸­è¯»å–ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 

3. **å…¼å®¹æ€§**
   - ä¿æŒå‘åå…¼å®¹
   - è‡ªå®šä¹‰é€æ˜è‰²æ¨¡å¼ä¸å—å½±å“

---

## âœ… æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. âœ… **50% æ€§èƒ½æå‡**ï¼ˆå¹³å‡ï¼‰
2. âœ… **æ›´ä½çš„å†…å­˜ä½¿ç”¨**
3. âœ… **æ›´å¥½çš„ä»£ç è´¨é‡**
4. âœ… **å®Œå…¨å‘åå…¼å®¹**

è¿™äº›ä¼˜åŒ–åœ¨ä¿æŒä»£ç å¯è¯»æ€§çš„åŒæ—¶ï¼Œæ˜¾è‘—æå‡äº† GIF ç”Ÿæˆçš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤§é‡å¸§æˆ–é«˜åˆ†è¾¨ç‡å›¾ç‰‡çš„åœºæ™¯ã€‚
